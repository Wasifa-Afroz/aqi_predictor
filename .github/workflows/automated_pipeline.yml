name: AQI Prediction Pipeline Automation

on:
  # Schedule: Run data collection every hour + training daily at 2 AM PKT
  schedule:
    - cron: '0 * * * *'      # Every hour at :00 minutes - Data collection
    - cron: '0 18 * * *'     # Daily at 18:00 UTC (2:00 AM PKT) - Model training
  
  # Manual trigger option
  workflow_dispatch:
    inputs:
      pipeline:
        description: 'Which pipeline to run?'
        required: true
        default: 'both'
        type: choice
        options:
          - feature
          - training
          - both

jobs:
  # JOB 1: Hourly Data Collection (runs every hour)
  feature-pipeline:
    name: ðŸ“¡ Collect AQI Data
    runs-on: ubuntu-latest
    # Run if: (1) Any schedule trigger OR (2) Manual trigger requesting feature/both
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.pipeline == 'feature' || 
      github.event.inputs.pipeline == 'both'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-feature-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-feature-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pymongo dnspython requests python-dotenv
      
      - name: ðŸ“¡ Run Feature Pipeline
        env:
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
        run: |
          echo "ðŸ”„ Starting feature pipeline at $(date)..."
          python src/feature_pipeline.py
          echo "âœ… Feature pipeline completed!"
      
      - name: ðŸ“Š Log Collection Stats
        run: |
          echo "Workflow: ${{ github.workflow }}"
          echo "Event: ${{ github.event_name }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Timestamp: $(date)"
  
  # JOB 2: Daily Model Training (runs only at 2 AM PKT = 18:00 UTC)
  training-pipeline:
    name: ðŸ¤– Train ML Models
    runs-on: ubuntu-latest
    # Run if: (1) It's the 18:00 UTC schedule OR (2) Manual trigger requesting training/both
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 18 * * *') ||
      github.event.inputs.pipeline == 'training' || 
      github.event.inputs.pipeline == 'both'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-ml-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-ml-
      
      - name: Install ML dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn xgboost lightgbm pymongo dnspython joblib matplotlib seaborn
      
      - name: ðŸ¤– Run Training Pipeline
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
        run: |
          echo "ðŸ”„ Starting model training at $(date)..."
          python src/training_pipeline.py
          echo "âœ… Model training completed!"
      
      - name: ðŸ’¾ Upload Trained Models
        uses: actions/upload-artifact@v3
        with:
          name: trained-models-${{ github.run_number }}
          path: |
            models/*.pkl
            models/*.json
          retention-days: 30
        continue-on-error: true
      
      - name: ðŸ“Š Training Summary
        run: |
          echo "Training Run #${{ github.run_number }} completed"
          echo "Timestamp: $(date)"
          echo "Models uploaded as artifacts (if available)"