name: AQI Prediction Pipeline Automation

on:
  # Run feature pipeline every hour
  schedule:
    - cron: '0 * * * *'  # Every hour at minute 0
  
  # Run training pipeline daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'  # Every day at 2 AM UTC (7 AM PKT)
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      pipeline_type:
        description: 'Which pipeline to run?'
        required: true
        default: 'both'
        type: choice
        options:
          - feature
          - training
          - both

jobs:
  # ============================================================================
  # JOB 1: FEATURE PIPELINE (Runs Every Hour)
  # ============================================================================
  feature-pipeline:
    name: ğŸ”„ Hourly Feature Collection
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 * * * *' || 
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.pipeline_type == 'feature' || github.event.inputs.pipeline_type == 'both')
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ” Verify Environment
        run: |
          python --version
          pip list | grep -E "pandas|numpy|requests|pymongo"
      
      - name: ğŸŒ Fetch Current AQI Data
        env:
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
        run: |
          echo "ğŸ”„ Running feature pipeline..."
          python src/feature_pipeline.py
          echo "âœ… Feature pipeline completed!"
      
      - name: ğŸ“Š Check Data Quality
        run: |
          if [ -f "data/feature_store/karachi_aqi_features.csv" ]; then
            echo "âœ… Feature store file exists"
            lines=$(wc -l < data/feature_store/karachi_aqi_features.csv)
            echo "ğŸ“Š Total records: $lines"
          else
            echo "âš ï¸ Feature store file not found"
          fi
      
      - name: ğŸ’¾ Commit New Data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          git add data/feature_store/ data/raw/ || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Auto-update: Hourly AQI data collection - $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
            echo "âœ… Data committed and pushed"
          fi
      
      - name: ğŸ“¢ Create Summary
        run: |
          echo "## ğŸ”„ Feature Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Data Source:** OpenWeather API" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 2: TRAINING PIPELINE (Runs Daily)
  # ============================================================================
  training-pipeline:
    name: ğŸ¤– Daily Model Training
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 2 * * *' || 
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.pipeline_type == 'training' || github.event.inputs.pipeline_type == 'both')
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ“Š Check Training Data
        run: |
          if [ -f "data/processed/training_data.csv" ]; then
            lines=$(wc -l < data/processed/training_data.csv)
            echo "âœ… Training data exists: $lines samples"
          else
            echo "âš ï¸ No training data found. Running backfill..."
            python src/backfill_data.py
          fi
      
      - name: ğŸ¯ Train ML Models
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
        run: |
          echo "ğŸ¯ Training ML models..."
          python src/training_pipeline.py
          echo "âœ… Training completed!"
      
      - name: ğŸ” Run SHAP Explainability
        run: |
          echo "ğŸ” Generating SHAP explanations..."
          python src/model_explainability.py
          echo "âœ… Explainability analysis completed!"
      
      - name: ğŸ“Š Generate Training Report
        run: |
          echo "# ğŸ¤– Automated Training Report" > training_report.md
          echo "" >> training_report.md
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> training_report.md
          echo "" >> training_report.md
          echo "## Model Performance" >> training_report.md
          echo "" >> training_report.md
          
          if [ -f "models/model_metrics.json" ]; then
            echo "âœ… Models trained successfully!" >> training_report.md
            echo "" >> training_report.md
            cat models/model_metrics.json >> training_report.md
          fi
          
          echo "" >> training_report.md
          echo "## Feature Importance" >> training_report.md
          echo "" >> training_report.md
          
          if [ -f "reports/feature_importance_report.txt" ]; then
            cat reports/feature_importance_report.txt >> training_report.md
          fi
          
          cat training_report.md
      
      - name: ğŸ’¾ Commit Updated Models
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          git add models/ visualizations/ reports/ training_report.md || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Auto-retrain: Daily model update - $(date -u +'%Y-%m-%d')"
            git push
            echo "âœ… Models committed and pushed"
          fi
      
      - name: ğŸ“¦ Upload Training Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: training-results-${{ github.run_number }}
          path: |
            models/*.pkl
            models/*.json
            visualizations/*.png
            reports/*.csv
            reports/*.txt
            training_report.md
          retention-days: 30
      
      - name: ğŸ“¢ Create Summary
        run: |
          echo "## ğŸ¤– Training Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Models:** Ridge, Random Forest, XGBoost, LightGBM" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "models/model_metrics.json" ]; then
            echo "### ğŸ“Š Model Metrics" >> $GITHUB_STEP_SUMMARY
            cat models/model_metrics.json >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ”” Notify on Failure
        if: failure()
        run: |
          echo "âŒ Training pipeline failed!"
          echo "Check logs for details."

  # ============================================================================
  # JOB 3: HEALTH CHECK (Runs after both pipelines)
  # ============================================================================
  health-check:
    name: âœ… System Health Check
    runs-on: ubuntu-latest
    needs: [feature-pipeline, training-pipeline]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3
      
      - name: ğŸ” Verify Data Integrity
        run: |
          echo "## ğŸ¥ System Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check feature store
          if [ -f "data/feature_store/karachi_aqi_features.csv" ]; then
            lines=$(wc -l < data/feature_store/karachi_aqi_features.csv)
            echo "âœ… Feature Store: $lines records" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Feature Store: Missing" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check models
          model_count=$(find models -name "*.pkl" 2>/dev/null | wc -l)
          echo "âœ… Models: $model_count files" >> $GITHUB_STEP_SUMMARY
          
          # Check visualizations
          viz_count=$(find visualizations -name "*.png" 2>/dev/null | wc -l)
          echo "âœ… Visualizations: $viz_count files" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Last Updated:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY