name: AQI Prediction Pipeline Automation

on:
  # TWO SCHEDULES:
  schedule:
    - cron: '0 * * * *'      # Every hour - Data collection
    - cron: '0 18 * * *'     # Daily at 2:00 AM PKT (18:00 UTC = 2 AM PKT+6)
  
  # Manual trigger option
  workflow_dispatch:
    inputs:
      pipeline:
        description: 'Which pipeline to run?'
        required: true
        default: 'both'
        type: choice
        options:
          - feature
          - training
          - both

jobs:
  # JOB 1: Hourly Data Collection
  feature-pipeline:
    name: ðŸ“¡ Collect AQI Data
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.pipeline == 'feature' || 
      github.event.inputs.pipeline == 'both'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pymongo dnspython requests python-dotenv
      
      - name: ðŸ“¡ Run Feature Pipeline
        env:
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
        run: |
          echo "ðŸ”„ Starting feature pipeline..."
          python src/feature_pipeline.py
          echo "âœ… Feature pipeline completed at $(date)"
  
  # JOB 2: Daily Training at 2 AM PKT
  training-pipeline:
    name: ðŸ¤– Train ML Models (Daily 2 AM)
    runs-on: ubuntu-latest
    # Check if it's the 2 AM schedule OR manual training request
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 18 * * *') ||
      github.event.inputs.pipeline == 'training' || 
      github.event.inputs.pipeline == 'both'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install ML dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn xgboost lightgbm pymongo dnspython joblib matplotlib seaborn
      
      - name: ðŸ¤– Run Training Pipeline
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
        run: |
          echo "ðŸ”„ Starting model training at $(date)..."
          python src/training_pipeline.py
          echo "âœ… Model training completed!"
      
      - name: ðŸ’¾ Upload Trained Models
        uses: actions/upload-artifact@v3
        with:
          name: trained-models-${{ github.run_number }}
          path: |
            models/*.pkl
            models/*.json
          retention-days: 30
```

---

### **Part 2: App.py Refresh Button**

The refresh button in your app **cannot trigger GitHub Actions directly** (GitHub doesn't allow that for security). 

**But here's what the refresh button WILL do:**

1. **Fetch fresh data from MongoDB** (that GitHub Actions collected hourly)
2. **Re-run predictions** with latest data
3. **Update the dashboard** instantly

**The workflow is:**
```
GitHub Actions (runs hourly) â†’ Saves to MongoDB â†’ App refresh button â†’ Reads from MongoDB