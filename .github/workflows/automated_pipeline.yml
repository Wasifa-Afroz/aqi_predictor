name: AQI Prediction Pipeline Automation

on:
  # Run feature pipeline every hour for data collection
  schedule:
    - cron: '0 * * * *'  # Every hour at minute 0
    - cron: '0 2 * * *'  # Daily at 2 AM UTC for model training
  
  # Manual trigger option
  workflow_dispatch:
    inputs:
      pipeline:
        description: 'Which pipeline to run?'
        required: true
        default: 'both'
        type: choice
        options:
          - feature
          - training
          - both

jobs:
  # JOB 1: Hourly Data Collection
  feature-pipeline:
    name: ğŸ“¡ Collect AQI Data
    runs-on: ubuntu-latest
    # Run if: (1) hourly schedule OR (2) manual trigger with feature/both
    if: |
      github.event.schedule == '0 * * * *' || 
      github.event.inputs.pipeline == 'feature' || 
      github.event.inputs.pipeline == 'both' ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pymongo dnspython requests python-dotenv
      
      - name: ğŸ“¡ Run Feature Pipeline
        env:
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
        run: |
          echo "ğŸ”„ Starting feature pipeline..."
          python src/feature_pipeline.py
          echo "âœ… Feature pipeline completed!"
      
      - name: ğŸ“Š Log Data Stats
        run: |
          echo "âœ… Data collection completed at $(date)"
          echo "ğŸ“ Data stored in MongoDB"
  
  # JOB 2: Daily Model Training (2 AM UTC)
  training-pipeline:
    name: ğŸ¤– Train ML Models
    runs-on: ubuntu-latest
    # Run if: (1) daily 2 AM schedule OR (2) manual trigger with training/both
    if: |
      github.event.schedule == '0 2 * * *' || 
      github.event.inputs.pipeline == 'training' || 
      github.event.inputs.pipeline == 'both'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-ml-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-ml-
      
      - name: Install ML dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn xgboost lightgbm pymongo dnspython joblib matplotlib seaborn
      
      - name: ğŸ¤– Run Training Pipeline
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
        run: |
          echo "ğŸ”„ Starting model training..."
          python src/training_pipeline.py
          echo "âœ… Model training completed!"
      
      - name: ğŸ’¾ Upload Trained Models
        uses: actions/upload-artifact@v3
        with:
          name: trained-models-${{ github.run_number }}
          path: |
            models/*.pkl
            models/*.json
          retention-days: 30
      
      - name: ğŸ“Š Training Summary
        run: |
          echo "âœ… Training completed at $(date)"
          echo "ğŸ“ Models uploaded as artifacts"
          echo "ğŸ¯ Check the Artifacts tab to download trained models"
  
  # JOB 3: Health Check & Notification
  health-check:
    name: ğŸ¥ System Health Check
    runs-on: ubuntu-latest
    needs: [feature-pipeline]
    if: always()
    
    steps:
      - name: Check Pipeline Status
        run: |
          echo "ğŸ“Š Pipeline Health Report"
          echo "========================"
          echo "Feature Pipeline: ${{ needs.feature-pipeline.result }}"
          echo "Timestamp: $(date)"
          echo "========================"
      
      - name: Notify on Failure
        if: needs.feature-pipeline.result == 'failure'
        run: |
          echo "âš ï¸ ALERT: Feature pipeline failed!"
          echo "Check the logs above for details"